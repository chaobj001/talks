Testing, Debugging and Profiling
23 Apr 2013
Tags: go test profile debug

Fabrizio Milo, Miki Tebeka
@fabmilo 
@tebeka

* Testing Recipe

- Write `test_<module>.go` (discovery based test system)
- With the same package as the one being tested
- import [[http://golang.org/pkg/testing/][testing]]
- Write `TestFoo(t`*testing.T)` functions
- Use `init` for setup
- Use `defer` for poor mans teardown (in *every* test function)
- Run `go`test`-v`
- Run `go`test`-run='.*Mul.*'`-v` to select tests
- Read `go`help`testflag` output for more options

* math.go

.code test-debug-prof/math/math.go

* math_test.go

.code test-debug-prof/math/math_test.go

* Table Driven Testing

TBD (Miki)

* Parallel Execution

TBD (Miki)

* Benchmarks

$ go test -c
$ ./bytes.test -test.run=XXX -test.bench=Index -test.cpuprofile=cpu.out  //-test.benchtime
$ go tool pprof bytes.test cpu.out

TBD (Miki)

* GDB

TBD (Fab)

* Gdb Configuration

source runtime-gdb.py
skip malloc.goc:436

* GDB 7.5 on Mac 
You need GDB 7.5

You need to sign your GDB
	gdb --version

If you need to upgrade on OS X, download latest stable release source code from
	http://sourceware.org/gdb/download/

Unpack and compile:
	tar xjvf gdb-7.4.tar.bz2
	cd gdb-7.4
	less gdb/README
	./configure
	make

Create a Certificate

.link http://sourceware.org/gdb/wiki/BuildingOnDarwin

Run it 
	codesign -s gdb-cert /path/to/my/new/gdb

	go build -gcflags "-N -l" gdbsandbox.go

- you can build a development version of dependent pkgs.

	go install -a -v -gcflags "-N -l" <pkgs-list>


Load GDB golang extensions:
	(gdb)source http://golang.org/src/pkg/runtime/runtime-gdb.py

Let's use gdb on geodns:

	go build -a -v -gcflags "-N -l" github.com/abh/geodns

Breakpoint on module function:
	(gdb) b main.main

Breakpoint on file line:
	(gdb) b serve.go:212

How to set an environemnt variable:

	set environment GOGCTRACE=1
	set environmnet GOMAXPROCS=1
	set environment GOTRACEBACK=2

How to set arguments:

	set args -port=5300

How to list local variables

	- info locals  // locals only 
	- info variables  // all variables including globals / static
	- info args
	- whatis <variablename>
	- info variables <regexp>
	- p <variablename>


* import "runtime/debug"

.link http://golang.org/pkg/runtime/debug/#PrintStack

.link http://golang.org/pkg/runtime/#Stack

	func Stack(buf []byte, all bool) int

Custom Exceptions: Extending Error's interface

.link https://code.google.com/p/biogo/source/browse/errors/errors.go

* GDB Commands

- list
- list line

- list file.go:line
- break line
- break file.go:line
- disas

* Go Extensions (2)

- bt
- frame n


* Go Extensions (3)

- p var
- p $len(var)
- p $dtype(var)
- iface var

- info goroutines
- goroutine n cmd
- help goroutine


* GDB  to know
	$ gdb --args mycode -command 1,2,3

- break lib fun
	(gdb) b net/http.ListenAndServe
- You can't call a Go function

	(gdb) call 'main.greet'("hello")
	infrun.c:5777: internal-error: normal_stop: Assertion `get_frame_type (frame) == DUMMY_FRAME' failed.
	A problem internal to GDB has been detected,
	further debugging may prove unreliable.
	Quit this debugging session? (y or n) y


* GDB UI
- gdb -tui
- ddd
- Affinic's

* Hopwatch

.play test-debug-prof/hopwatch.go


* Profiling

* Running the Memory Profiler

* Notes


in pre Go 1.0 the memory profiler requires that the garbage collection has run at least once.
To force the GC use runtime.GC() i.e:

    DumpHeapProfile("pre-gc-mem.prof")
	runtime.GC() // force Garbage Collection
	DumpHeapProfile("post-gc-mem.prof")

The value of runtime.MemProfileRate is important to tweak as it adjusts the granularity of the stats, the default is to only consider allocations of 512kb or bigger. 

.link http://golang.org/pkg/runtime/#pkg-variables


	go tool pprof <Executable> executable.prof

install graphviz



* Testing References

- [[http://golang.org/pkg/testing/][testing]]
- [[http://golang.org/doc/code.html#Testing][Testing]] section in "How To Write Go Code"
- [[http://labix.org/gocheck][gocheck]]
- [[https://bitbucket.org/tebeka/go2xunit][go2xunit]] Jenkins integration


* Debugging References

- [[http://golang.org/doc/gdb][gdb]]
- [[http://www.affinic.com/?page_id=109][Visual GDB Debugger]]
- [[https://github.com/emicklei/hopwatch][HopWatch]]






